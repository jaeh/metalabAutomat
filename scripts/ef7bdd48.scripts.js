"use strict";angular.module("automatApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngTouch","hc.marked","ngLocalStore","xc.indexedDB","mgcrea.ngStrap","ab-base64"]).config(["$routeProvider","$indexedDBProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"});var c=1;b.connection("metalab").upgradeDatabase(c,function(a,b){b.createObjectStore("automat",{keyPath:"dir"}),b.createObjectStore("settings",{keyPath:"lastModified"})})}]),angular.module("automatApp").controller("MainCtrl",["$scope","$http","$interval","base64","$indexedDB",function(a,b,c,d,e){var f="683b134e2e89d670c797e1d77e9e6bfca3b62192",g="https://api.github.com/repos/zerocity/metalabAutomat/contents/",h="https://api.github.com/repos/zerocity/metalabAutomat/git/trees/master",i="?callback=JSON_CALLBACK",j="&recursive=1",k="&access_token="+f,l={headers:{Authorization:"token "+f,Accept:"application/vnd.github-blob.raw","X-Testing":"testing"}};a.progressBar=0;var m=e.objectStore("automat"),n=e.objectStore("settings"),o=function(a){return d.decode(a.replace(/\n/g,""))},p=function(){n.getAll().then(function(b){a.lastModified=b[b.length-1].lastModified})},q=function(){var c=b.jsonp(g+i+k);return"undefined"!=typeof a.lastModified?(p(),c.then(function(b){return b.data.meta["Last-Modified"]===a.lastModified?!0:!1})):void p()},r=function(){var c=[],d=[],e=b.jsonp(h+i+j+k,l);e.then(function(b){n.clear(),n.insert({lastModified:b.data.meta["Last-Modified"]}),p();var e=b.data.data.tree;a.maxProgress=e.length;for(var f=0;f<e.length;f++){var g=e[f].path,h=g.indexOf(".md");a.img;var i=g.indexOf("listview.jpg"),j=g.indexOf("/")+1,k=g.slice(0,j-1);if(h>=0){var l=g.slice(j,h),o=l.match(/\d+ Euro/);o=o?o[0]:"",c.push({dir:k,title:l,euro:o,url:e[f].url}),s(e[f].url,k).then(function(b){a.progressBar++;var d=_.findWhere(c,{dir:b.dir});d.md=b.src})}else i>=0?s(e[f].url,k).then(function(b){var f=_.findWhere(c,{dir:b.dir});f.src=b.src,d.push(f),a.progressBar++,a.progressBar===e.length&&(console.log("Data is inserted in indexedDB"),m.clear().then(function(){}),m.insert(d),a.data=d)}):a.progressBar++}})};a.isProgressActive=function(){return a.progressBar===a.maxProgress||0===a.progressBar?"hide":"active"};var s=function(a,c){return b.jsonp(a+i+k,l).then(function(a){return{src:a.data.data.content,dir:c}})};m.getAll().then(function(b){a.data=b}),c(function(){q().then(function(a){a===!1&&(console.log("... update indexedDB"),r())})},36e5),a.setModalContent=function(b){var c=_.findWhere(a.data,{dir:b});a.modal.content=c.md,a.modal.img=c.img},a.modal={title:void 0,content:void 0},a.markdown=function(){return"undefined"==typeof a.modal.content?"loading ...":marked(o(a.modal.content))}}]);